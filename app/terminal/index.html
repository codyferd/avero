<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Avero Terminal</title>
    <link rel="stylesheet" href="../../share/theme.css">
    <script src="../../share/cdn.js"></script>
    <script src="../../share/storage.js"></script>
    <style>
        [v-cloak] { display: none; }
        body, html { height: 100%; margin: 0; background: #020204; color: #4ade80; font-family: 'Fira Code', monospace; overflow: hidden; }
        
        .term-window {
            height: 100vh; display: flex; flex-direction: column; padding: 20px;
            background: radial-gradient(circle at center, #0a0a15 0%, #020204 100%);
            position: relative;
        }

        /* Scanline CRT Effect */
        .term-window::after {
            content: " "; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        .output-area { flex: 1; overflow-y: auto; z-index: 1; padding-bottom: 20px; }
        .prompt-line { display: flex; gap: 10px; align-items: center; position: relative; z-index: 3; }
        
        .user { color: #6366f1; font-weight: 900; }
        .path { color: #f43f5e; font-weight: 900; }
        
        input { 
            background: transparent; border: none; outline: none; color: inherit; 
            font-family: inherit; font-size: 14px; width: 100%;
        }

        .line { margin-bottom: 8px; line-height: 1.6; }
        .cmd-out { color: #94a3b8; white-space: pre-wrap; display: block; margin-left: 20px; border-left: 1px solid #1e293b; padding-left: 15px; }
        
        /* High-tech scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 2px; }
    </style>
</head>
<body class="avero-app">

<div id="app" v-cloak class="term-window" @click="focusInput">
    <div class="output-area" ref="scrollRef">
        <div class="opacity-40 text-[9px] uppercase tracking-[0.5em] mb-10 border-b border-white/5 pb-2 flex justify-between">
            <span>Avero Core Shell v2.1.0</span>
            <span>Auth: {{ user }}</span>
        </div>

        <div v-for="(log, i) in logs" :key="i" class="line">
            <div class="flex gap-2">
                <span class="user">avero@system</span>
                <span class="path">{{ log.path }} $</span>
                <span class="text-white">{{ log.input }}</span>
            </div>
            <div v-if="log.output" class="cmd-out">{{ log.output }}</div>
        </div>

        <div class="prompt-line">
            <span class="user">avero@system</span>
            <span class="path">{{ currentPathStr }} $</span>
            <input ref="inputRef" v-model="currentInput" 
                   @keydown.enter="submit" 
                   @keydown.up.prevent="historyStep(-1)"
                   @keydown.down.prevent="historyStep(1)"
                   @keydown.tab.prevent="autoComplete"
                   spellcheck="false" autocomplete="off" autofocus>
        </div>
    </div>
</div>

<script type="module">
import { Commands } from './commands.js';
const { createApp, ref, computed, nextTick } = Vue;

createApp({
    setup() {
        const logs = ref([]);
        const currentInput = ref("");
        const history = ref([]);
        const historyIdx = ref(-1);
        const path = ref(['avero', 'user']);
        const user = ref("root");
        
        const inputRef = ref(null);
        const scrollRef = ref(null);

        const currentPathStr = computed(() => `/${path.value.join('/')}`);

        const focusInput = () => inputRef.value.focus();

        const submit = async () => {
            const raw = currentInput.value.trim();
            if (!raw) return;

            history.value.push(raw);
            historyIdx.value = history.value.length;

            const [cmd, ...args] = raw.split(" ");
            let output = "";

            if (cmd === "clear") {
                logs.value = [];
            } else if (Commands[cmd]) {
                // Fetch fresh FS for every command to ensure sync
                const fs = AveroStorage.getFS();
                const state = { path: path.value, user: user.value };
                
                output = await Commands[cmd](args, fs, state);
                
                // If command modifies path (like 'cd'), update local state
                path.value = state.path;
            } else {
                output = `sh: command not found: ${cmd}`;
            }

            if (cmd !== "clear") {
                logs.value.push({ input: raw, output, path: currentPathStr.value });
            }

            currentInput.value = "";
            nextTick(() => scrollRef.value.scrollTop = scrollRef.value.scrollHeight);
        };

        const historyStep = (dir) => {
            const newIdx = historyIdx.value + dir;
            if (newIdx >= 0 && newIdx < history.value.length) {
                historyIdx.value = newIdx;
                currentInput.value = history.value[newIdx];
            } else if (newIdx === history.value.length) {
                historyIdx.value = newIdx;
                currentInput.value = "";
            }
        };

        const autoComplete = () => {
            const fs = AveroStorage.getFS();
            const currentItems = fs.filter(f => f.path === path.value.join('/'));
            const match = currentItems.find(i => i.name.startsWith(currentInput.value));
            if (match) currentInput.value = match.name;
        };

        return { logs, currentInput, currentPathStr, inputRef, scrollRef, focusInput, submit, historyStep, autoComplete, user };
    }
}).mount('#app');
</script>
</body>
</html>
