<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Avero Files</title>
    <link rel="stylesheet" href="../../share/theme.css">
    <script src="../../share/cdn.js"></script>
    <script src="../../share/storage.js"></script>
    <style>
        [v-cloak] { display: none; }
        body, html { height: 100%; margin: 0; background: #000; color: #fff; overflow: hidden; }
        .app-layout { display: grid; grid-template-rows: 60px 1fr; height: 100vh; }
        .toolbar { background: #0d0d12; border-bottom: 1px solid #222; display: flex; align-items: center; padding: 0 20px; gap: 10px; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 25px; overflow-y: auto; }
        .item { display: flex; flex-direction: column; align-items: center; padding: 15px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; }
        .item:hover { background: rgba(255,255,255,0.05); }
        .item.selected { background: rgba(99, 102, 241, 0.2); border-color: #6366f1; }
        .icon { font-size: 32px; margin-bottom: 8px; }
        .label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #777; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; }
        .selected .label { color: #fff; }
    </style>
</head>
<body class="avero-app">
<div id="app" v-cloak class="app-layout">
    <header class="toolbar">
        <button @click="path.pop()" :disabled="path.length <= 2" class="avero-btn">BACK</button>
        <div class="flex-1 text-[10px] font-bold opacity-30 uppercase tracking-widest">/ {{ path.join(' / ') }}</div>
        
        <button @click="openModal('file')" class="avero-btn">NEW FILE</button>
        <button @click="$refs.uploader.click()" class="avero-btn">UPLOAD</button>
        <button @click="deleteItem" :disabled="!selectedId" class="avero-btn !text-red-500">DELETE</button>
        <button @click="zipOut" class="avero-btn !bg-indigo-600">ZIP BACKUP</button>
        
        <input type="file" ref="uploader" @change="upload" class="hidden" multiple>
    </header>

    <div class="file-grid" @click.self="selectedId = null">
        <div v-for="f in folders" :key="f.id" class="item" :class="{selected: selectedId === f.id}" @click="selectedId = f.id" @dblclick="path.push(f.name)">
            <div class="icon">üìÅ</div>
            <div class="label">{{ f.name }}</div>
        </div>
        <div v-for="f in files" :key="f.id" class="item" :class="{selected: selectedId === f.id}" @click="selectedId = f.id" @dblclick="openModal('file', f)">
            <div class="icon">üìÑ</div>
            <div class="label">{{ f.name }}</div>
        </div>
    </div>

    <div v-if="modal.show" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-10">
        <div class="bg-[#111] border border-[#222] w-full h-full rounded-xl flex flex-col p-6 gap-4">
            <input v-model="modal.name" class="avero-input" placeholder="filename.txt">
            <textarea v-model="modal.content" class="avero-input flex-1 font-mono"></textarea>
            <div class="flex gap-4">
                <button @click="modal.show = false" class="avero-btn flex-1">CANCEL</button>
                <button @click="save" class="avero-btn flex-1 !bg-indigo-600">SAVE FILE</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;
createApp({
    setup() {
        const path = ref(['avero', 'user']);
        const fs = ref([]);
        const selectedId = ref(null);
        const modal = ref({ show: false, name: '', content: '', id: null });

        const refresh = () => { fs.value = AveroStorage.getFS(); };
        const currentPathStr = computed(() => path.value.join('/'));
        const files = computed(() => fs.value.filter(f => f.path === currentPathStr.value && !f.isDir));
        const folders = computed(() => fs.value.filter(f => f.path === currentPathStr.value && f.isDir && f.name !== 'user'));

        const save = () => {
            AveroStorage.save(modal.value.name, modal.value.content, currentPathStr.value, false, modal.value.id);
            modal.show = false; refresh();
        };

        const upload = (e) => {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (res) => { 
                    AveroStorage.save(file.name, res.target.result, currentPathStr.value, false);
                    refresh();
                };
                reader.readAsText(file);
            });
        };

        const zipOut = async () => {
            const zip = new JSZip();
            fs.value.filter(f => !f.isDir).forEach(f => zip.file(f.name, f.content));
            const blob = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "avero_fs_backup.zip";
            a.click();
        };

        onMounted(() => { refresh(); window.addEventListener('storage', refresh); });
        return { path, files, folders, selectedId, modal, save, upload, zipOut, deleteItem: () => { AveroStorage.delete(selectedId.value); selectedId.value = null; refresh(); }, openModal: (type, item) => modal.value = { show: true, name: item?.name||'', content: item?.content||'', id: item?.id||null } };
    }
}).mount('#app');
</script>
</body>
</html>
