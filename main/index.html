<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avero</title>
    <script src="../cdn.js"></script>
    <style>
        [v-cloak] { display: none; }
        .glass-dark { 
            background: rgba(10, 10, 15, 0.7); 
            backdrop-filter: blur(30px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Grid Tiling Logic */
        .desktop-grid { display: grid; gap: 10px; padding: 10px; height: 100%; width: 100%; transition: 0.3s; }
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .grid-3 > :first-child { grid-row: span 2; }
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }

        /* Dragging States */
        .tab-dragging { opacity: 0.4; transform: scale(0.95); }
        .tab-drop-over { background: rgba(99, 102, 241, 0.4) !important; border-color: #6366f1 !important; }
        
        iframe { background: white; border-radius: 8px; }
        .app-header { height: 32px; background: rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: space-between; }
    </style>
</head>
<body class="overflow-hidden bg-slate-950 text-slate-100 font-sans select-none">

<div id="app" v-cloak class="h-screen w-screen flex flex-col relative bg-cover bg-center"
     style="background-image: url('../media/background.avif')">

    <header class="h-12 glass-dark flex items-center px-4 z-[100] gap-4">
        <button @click="isDrawerOpen = !isDrawerOpen" class="h-8 w-8 bg-indigo-600 rounded-lg flex items-center justify-center hover:bg-indigo-500 transition-all active:scale-90 font-black text-xs">A</button>
        
        <div class="flex gap-1 flex-1 overflow-x-auto no-scrollbar">
            <div v-for="d in desktops" :key="d.id" 
                 draggable="true"
                 @dragstart="onTabDragStart($event, d)"
                 @dragover.prevent="dragOverTabId = d.id"
                 @dragleave="dragOverTabId = null"
                 @drop="onTabDrop($event, d)"
                 @click="activeDesktopId = d.id"
                 class="h-9 px-4 rounded-xl flex items-center gap-3 cursor-pointer transition-all border"
                 :class="[
                    activeDesktopId === d.id ? 'bg-white/10 border-white/20 text-white shadow-lg' : 'bg-transparent border-transparent text-slate-400 hover:bg-white/5',
                    dragOverTabId === d.id ? 'tab-drop-over' : ''
                 ]">
                <span class="text-[10px] font-black uppercase tracking-widest">{{ d.name }}</span>
                <button @click.stop="closeDesktop(d.id)" class="hover:text-red-400 text-xs">âœ•</button>
            </div>
        </div>

        <div class="text-[10px] font-bold opacity-40 uppercase tracking-widest">{{ currentTime }}</div>
    </header>

    <div v-if="isDrawerOpen" class="absolute top-14 left-4 w-72 glass-dark rounded-2xl p-5 z-[1000] shadow-2xl border border-white/10">
        <h2 class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-4">Launcher</h2>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div v-for="app in appList" :key="app.id" 
                 draggable="true" @dragstart="onAppDragStart($event, app)"
                 @click="launchNewDesktop(app)"
                 class="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-white/10 cursor-pointer transition-all group">
                <span class="text-3xl group-hover:scale-110 transition-transform">{{ app.icon }}</span>
                <span class="text-[10px] font-bold">{{ app.title }}</span>
            </div>
        </div>
        <div class="pt-4 border-t border-white/5">
            <div class="flex bg-black/40 rounded-xl border border-white/10 p-1">
                <input v-model="urlInput" @keyup.enter="launchUrl" placeholder="Enter URL (e.g. google.com)" class="bg-transparent border-none outline-none flex-1 text-[10px] px-2 py-1 text-white">
                <button @click="launchUrl" class="bg-indigo-600 px-3 rounded-lg text-[9px] font-black uppercase">Go</button>
            </div>
        </div>
    </div>

    <main class="flex-1 relative overflow-hidden" @dragover.prevent @drop="onDropIntoMain">
        <div v-if="activeDesktop" :class="['desktop-grid', 'grid-' + activeDesktop.apps.length]">
            <div v-for="app in activeDesktop.apps" :key="app.instanceId" class="flex flex-col glass-dark rounded-xl overflow-hidden border border-white/10">
                <div class="h-8 flex items-center justify-between px-3 bg-white/5">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">{{ app.title }}</span>
                    <button @click="closeApp(app.instanceId)" class="text-slate-500 hover:text-red-500 text-xs">âœ•</button>
                </div>
                <iframe :src="app.path" class="flex-1 w-full h-full border-none"></iframe>
            </div>
        </div>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const currentTime = ref('');
        const isDrawerOpen = ref(false);
        const urlInput = ref('');
        const desktops = ref([]); 
        const activeDesktopId = ref(null);
        
        const draggedItem = ref(null); // Can be an App or a Desktop
        const dragType = ref(null);    // 'app' or 'desktop'
        const dragOverTabId = ref(null);

        const appList = [
            { id: 0, title: 'About', icon: 'ðŸ ', path: '../home' },
            { id: 1, title: 'Calculator', icon: 'ðŸ”¢', path: '../calculator/index.html' },
            { id: 2, title: 'Chess', icon: 'â™Ÿï¸', path: '../chess/index.html' },
            { id: 3, title: 'Superbird', icon: 'ðŸ¦', path: '../superbirdjumper3/index.html' },
            { id: 4, title: 'Files', icon: 'ðŸ“‚', path: '../files/index.html' },
            { id: 5, title: 'Terminal', icon: 'ðŸ“¦', path: '../terminal/index.html'}
        ];

        const activeDesktop = computed(() => desktops.value.find(d => d.id === activeDesktopId.value));

        const launchNewDesktop = (app) => {
            const id = Date.now();
            desktops.value.push({ id, name: app.title, apps: [{ ...app, instanceId: Math.random() }] });
            activeDesktopId.value = id;
            isDrawerOpen.value = false;
        };

        const launchUrl = () => {
            let val = urlInput.value.trim();
            if (!val) return;
            if (!val.startsWith('http')) val = 'https://' + val;
            const id = Date.now();
            desktops.value.push({ id, name: urlInput.value.split('.')[0], apps: [{ title: 'Web', icon: 'ðŸŒ', path: val, instanceId: Math.random() }] });
            activeDesktopId.value = id;
            urlInput.value = '';
            isDrawerOpen.value = false;
        };

        // DRAG START HANDLERS
        const onAppDragStart = (e, app) => {
            dragType.value = 'app';
            draggedItem.value = app;
            isDrawerOpen.value = false;
        };

        const onTabDragStart = (e, desktop) => {
            dragType.value = 'desktop';
            draggedItem.value = desktop;
        };

        // DROP HANDLERS
        const onTabDrop = (e, targetDesktop) => {
            dragOverTabId.value = null;
            if (!draggedItem.value) return;

            if (dragType.value === 'app') {
                // Merge App into Existing Tab
                targetDesktop.apps.push({ ...draggedItem.value, instanceId: Math.random() });
                targetDesktop.name = "Split View";
            } else if (dragType.value === 'desktop' && draggedItem.value.id !== targetDesktop.id) {
                // Merge Desktop into Desktop
                targetDesktop.apps.push(...draggedItem.value.apps);
                targetDesktop.name = "Merged View";
                closeDesktop(draggedItem.value.id); // Delete the old tab
            }
            activeDesktopId.value = targetDesktop.id;
            draggedItem.value = null;
        };

        const onDropIntoMain = () => {
            if (dragType.value === 'app' && activeDesktop.value) {
                activeDesktop.value.apps.push({ ...draggedItem.value, instanceId: Math.random() });
                activeDesktop.value.name = "Split View";
            }
            draggedItem.value = null;
        };

        const closeApp = (instanceId) => {
            if (!activeDesktop.value) return;
            activeDesktop.value.apps = activeDesktop.value.apps.filter(a => a.instanceId !== instanceId);
            if (activeDesktop.value.apps.length === 0) closeDesktop(activeDesktop.value.id);
        };

        const closeDesktop = (id) => {
            desktops.value = desktops.value.filter(d => d.id !== id);
            if (activeDesktopId.value === id) {
                activeDesktopId.value = desktops.value.length ? desktops.value[0].id : null;
            }
        };

        onMounted(() => {
            setInterval(() => {
                currentTime.value = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            }, 1000);
        });

        return { 
            appList, desktops, activeDesktopId, activeDesktop, isDrawerOpen,
            launchNewDesktop, launchUrl, urlInput, currentTime, 
            closeDesktop, closeApp, onAppDragStart, onTabDragStart, onTabDrop, onDropIntoMain, dragOverTabId
        };
    }
}).mount('#app');
</script>
</body>
</html>
